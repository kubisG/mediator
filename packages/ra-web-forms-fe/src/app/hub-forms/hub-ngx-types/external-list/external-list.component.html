<div [formGroup]="form">
  <div *ngIf="lists && form.controls[field.key]">
    <mat-form-field>
      <mat-select *ngIf="!field.templateOptions.required && !field.templateOptions.multiple" [placeholder]="field.templateOptions.label" [compareWith]="compareFn" [formControlName]="field.key" [formlyAttributes]="field">
        <mat-option *ngFor="let list of lists" [value]="list">
          {{ list[field.templateOptions.externalList.displayExpr] }}
        </mat-option>
      </mat-select>

      <mat-select *ngIf="!field.templateOptions.required && field.templateOptions.multiple" [placeholder]="field.templateOptions.label" [compareWith]="compareFn" [formControlName]="field.key" [formlyAttributes]="field" multiple>
        <mat-option *ngFor="let list of lists" [value]="list">
          {{ list[field.templateOptions.externalList.displayExpr] }}
        </mat-option>
      </mat-select>

      <mat-select *ngIf="field.templateOptions.required && !field.templateOptions.multiple" [placeholder]="field.templateOptions.label" [compareWith]="compareFn" [formControlName]="field.key" [formlyAttributes]="field" required>
        <mat-option *ngFor="let list of lists" [value]="list">
          {{ list[field.templateOptions.externalList.displayExpr] }}
        </mat-option>
      </mat-select>

      <mat-select *ngIf="field.templateOptions.required && field.templateOptions.multiple" [placeholder]="field.templateOptions.label" [compareWith]="compareFn" [formControlName]="field.key" [formlyAttributes]="field" multiple required>
        <mat-option *ngFor="let list of lists" [value]="list">
          {{ list[field.templateOptions.externalList.displayExpr] }}
        </mat-option>
      </mat-select>      

      <mat-error *ngIf="field.templateOptions.required && form.controls[field.key].hasError('required')">
        This field is required
      </mat-error>
    </mat-form-field>
  </div>
</div>
