properties([buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5')),
                        parameters([booleanParam(defaultValue: true, description: 'Enable if you want build.', name: 'BUILD'),
                        booleanParam(defaultValue: false, description: 'Enable if you want to create bundle.', name: 'BUNDLE'),
                        stringParam(defaultValue: '612810951372.dkr.ecr.eu-west-1.amazonaws.com', description: 'ECR Registry', name: 'DOCKER_REGISTRY'),
                        stringParam(description: 'Project name', name: 'PROJECT_NAME'),
                        stringParam(description: 'image name', name: 'IMG_NAME'),
                        ])
        ])
node("centos7"){
    try {
        timestamps {
            def scmVars;
            stage ('Clean') {
                cleanWs()
                deleteDir()
            }
            stage('Clone'){
                scmVars = checkout scm;
            }
            stage('Build'){
                if(params.BUILD == 'true'){
                    pushDocker(params.PROJECT_NAME,params.DOCKER_REGISTRY, params.IMG_NAME, scmVars.GIT_COMMIT.take(8), env.BRANCH_NAME)
                }
            }
            stage('Bundle'){
                if(params.BUNDLE == 'true'){
                    def imageTag = "${env.BRANCH_NAME}.${(new Date().format( 'yyyyMMdd' ))}.${scmVars.GIT_COMMIT.take(8)}"
                    sh "npm install"
                    sh "node ./scripts/builder/builder.js --project ${params.PROJECT_NAME} --rootDir ."
                    sh "mkdir bundle"
                    sh "mv ./packages/${params.PROJECT_NAME}/config ./bundle/config"
                    sh "mv ./packages/${params.PROJECT_NAME}/node_modules ./bundle/node_modules"
                    sh "cp -a ./node_modules/. ./bundle/node_modules"
                    sh "mv ./packages/${params.PROJECT_NAME}/dist ./bundle/dist"
                    sh "cp ./packages/${params.PROJECT_NAME}/package*.json ./bundle"
                    sh "cp ./packages/${params.PROJECT_NAME}/ecosystem.config.js ./bundle"
                    sh "mv ./packages/${params.PROJECT_NAME}/db ./bundle/db"
                    sh "tar -czvf ${params.IMG_NAME}.${imageTag}.tar.gz -C ./bundle ."
                    sh "aws s3 cp ${params.IMG_NAME}.${imageTag}.tar.gz s3://rapid-addition-build-transfer/development/jenkins/build-artifacts/ra-web/"
                }
            }
        }
    } catch (e) {
        // If there was an exception thrown, the build failed
        currentBuild.result = "FAILED"
        throw e
    } finally {
        // Success or failure, always send notifications
        notifyBuild(currentBuild.result,params.REPO_NAME)
    }
}

void pushDocker(String project,String registry, String imgName, String shortHash, String branch) {
    def hash = "${branch}.${(new Date().format( 'yyyyMMdd' ))}.${shortHash}"
    def imageTagLatest = "${branch}.${(new Date().format( 'yyyyMMdd' ))}.latest"
    sh "echo `aws ecr get-login --no-include-email --region eu-west-1` | sudo sh"
    sh "sudo docker system prune -f"
    sh "sudo docker build --build-arg project="+project+" . -t "+registry+"/"+imgName+":"+hash
    sh "sudo docker push "+registry+"/"+imgName+":"+hash
    sh "sudo docker tag "+registry+"/"+imgName+":"+hash+" "+registry+"/"+imgName+":"+imageTagLatest
    sh "sudo docker push "+registry+"/"+imgName+":"+imageTagLatest
}

def notifyBuild(String buildStatus = 'STARTED', String repo) {
  // build status of null means successful
  buildStatus =  buildStatus ?: 'SUCCESSFUL'

  // Default values
  def colorName = 'RED'
  def colorCode = '#FF0000'
  def subject = "${buildStatus}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'"
  def summary = "${subject} (${env.BUILD_URL})"
  def details = """<p>STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
    <p>Check console output at &QUOT;<a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>&QUOT;</p>"""

  // Override default values based on build status
  if (buildStatus == 'STARTED') {
    color = 'YELLOW'
    colorCode = '#FFFF00'
  } else if (buildStatus == 'SUCCESSFUL') {
    color = 'GREEN'
    colorCode = '#00FF00'
  } else {
    color = 'RED'
    colorCode = '#FF0000'
  }

  // Send notifications
  slackSend (color: colorCode, message: summary)

}
