properties([buildDiscarder(logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '', daysToKeepStr: '', numToKeepStr: '5')),
                        parameters([stringParam(defaultValue: 'true', description: 'Enable if you want build.', name: 'BUILD'),
						stringParam(defaultValue: 'false', description: 'Enable if you want deploy.', name: 'DEPLOY'),
                        stringParam(defaultValue: 'latest', description: 'Specific GIT revision to build', name: 'GIT_COMMIT'),
                        stringParam(defaultValue: 'test', description: 'Target environment', name: 'TARGET_ENV'),
                        stringParam(defaultValue: '612810951372.dkr.ecr.eu-west-1.amazonaws.com', description: 'ECR Registry', name: 'DOCKER_REGISTRY'),
                        stringParam(defaultValue: 'release', description: 'Repo branch', name: 'BRANCH_NAME'),
                        stringParam(description: 'Repo name', name: 'REPO_NAME')
                        ])
        ])
node("centos7"){
    stage('Clone'){
        checkout([
            $class: 'GitSCM',
            branches: [
                [name: '*/master']
            ],
            doGenerateSubmoduleConfigurations: false,
            extensions: [
                [$class: 'SubmoduleOption', disableSubmodules: false, parentCredentials: true, recursiveSubmodules: true, reference: '', trackingSubmodules: false],
                [$class: 'CheckoutOption', timeout: 10],
                [$class: 'CloneOption', depth: 0, noTags: false, reference: '', shallow: false, timeout: 10]
            ],
            submoduleCfg: [],
            userRemoteConfigs: [
                [credentialsId: 'hajek', url: 'git@bitbucket.org:rapid-addition/ra-web.git']
            ]
        ]);
    }
    stage('Build'){
        if(params.BUILD == 'true'){
            sh "git submodule foreach 'git checkout "+params.BRANCH_NAME+" || :'"
            sh "npm install"
            sh "npm run init"
            sh "npm run bundle"
            sh "npm run "+params.REPO_NAME
            sh "cd packages/"+params.REPO_NAME
            sh "sudo docker build . -t "+registry+"/"+params.REPO_NAME+":"+shortHash+"-"+branch
        }
    }
    stage('Log'){
        sh """
            ls -lattr packages/ra-trader-be/dist
            ls -lattr packages
        """
        echo params.BUILD;
        echo params.DEPLOY;
        echo params.GIT_COMMIT;
        echo params.TARGET_ENV;
        echo params.DOCKER_REGISTRY;
        echo params.BRANCH_NAME;
        echo params.REPO_NAME;
    }
}
